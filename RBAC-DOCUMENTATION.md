# 🛡️ MirageML RBAC — Система управления доступом

## Роли пользователей

| Роль | Email | Пароль | Описание |
|------|-------|--------|----------|
| **developer** | `developer@mirageml.com` | `mirage2026` | Полный контроль над системой |
| **moderator** | `moderator@mirageml.com` | `moderator123` | Ограниченный доступ |
| **admin** (legacy) | `admin@mirageml.com` | `admin123` | Для совместимости |

---

## 📊 Матрица прав доступа

### Разработчик (developer)
| Ресурс | Чтение | Создание | Редактирование | Удаление |
|--------|--------|----------|----------------|----------|
| Пользователи | ✅ | ✅ | ✅ | ✅ |
| Проекты | ✅ | ✅ | ✅ | ✅ |
| Сессии | ✅ | ✅ | ✅ | ✅ |
| Отзывы | ✅ | ✅ | ✅ | ✅ (вкл. модерацию) |
| Дашборд | ✅ | - | - | - |
| Профиль | ✅ | - | ✅ | ✅ (смена пароля) |

### Модератор (moderator)
| Ресурс | Чтение | Создание | Редактирование | Удаление |
|--------|--------|----------|----------------|----------|
| Пользователи | ✅ | ❌ | ❌ | ❌ |
| Проекты | ✅ | ✅ | 🔒 Только свои | 🔒 Только свои |
| Сессии | ✅ | ❌ | 🔒 Только свои | 🔒 Только свои |
| Отзывы | ✅ | ❌ | ❌ | ❌ (но может одобрять) |
| Дашборд | ✅ | - | - | - |
| Профиль | ✅ | - | ✅ | ✅ (смена пароля) |

---

## 🔐 Что видит каждая роль на localhost:3001/admin

### Разработчик (developer)
```
┌─────────────────────────────────────────────────────────────┐
│  MirageML Admin                          [Разработчик]      │
├─────────────────────────────────────────────────────────────┤
│  🏠 Главная          → Полная статистика по всем ролям     │
│  👥 Пользователи     → Полный список + создание/удаление   │
│  📁 Проекты          → Все проекты + полное управление     │
│  🕐 Сессии           → Все активные сессии                 │
│  💬 Отзывы           → Все отзывы + модерация              │
│  ⚙️ Профиль          → Редактирование + смена пароля       │
└─────────────────────────────────────────────────────────────┘
```

### Модератор (moderator)
```
┌─────────────────────────────────────────────────────────────┐
│  MirageML Admin                          [Модератор]        │
├─────────────────────────────────────────────────────────────┤
│  🏠 Главная          → Статистика (без деталей по ролям)   │
│  👥 Пользователи     → ТОЛЬКО просмотр (без кнопок)        │
│  📁 Проекты          → Свои проекты + чужие (просмотр)     │
│  🕐 Сессии           → Свои сессии + общие (просмотр)      │
│  💬 Отзывы           → Просмотр + одобрение                │
│  ⚙️ Профиль          → Редактирование + смена пароля       │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 API Endpoints с RBAC

### Защищённые endpoints
```
GET  /admin              → requireAdminAuth
GET  /admin/users        → requireAdminAuth + role check
GET  /admin/projects     → requireAdminAuth + ownership check
POST /api/admin/profile  → requireAdminAuth
PUT  /api/admin/profile  → requireAdminAuth
POST /api/admin/change-password → requireAdminAuth
```

### Middleware
```javascript
// Проверка авторизации
requireAdminAuth(req, res, next)

// Проверка прав доступа
requirePermission(resource, action)(req, res, next)

// Только для разработчиков
requireDeveloper(req, res, next)
```

---

## 📁 Структура файлов

```
mirageml-backend/
├── models/
│   └── user-roles.js       # Константы ролей и прав доступа
├── views/
│   ├── admin-layout.ejs    # Общий layout с отображением роли
│   ├── admin-dashboard.ejs # Дашборд со статистикой по ролям
│   └── admin-profile.ejs   # Профиль с бейджем роли
├── data/
│   └── users.json          # Пользователи с полем role
└── server.js               # Маршруты с RBAC
```

---

## 🚀 Быстрый старт

1. Запустить сервер:
   ```bash
   cd mirageml-backend
   node server.js
   ```

2. Войти как разработчик:
   - URL: http://localhost:3001/admin
   - Email: `developer@mirageml.com`
   - Пароль: `mirage2026`

3. Войти как модератор:
   - URL: http://localhost:3001/admin
   - Email: `moderator@mirageml.com`
   - Пароль: `moderator123`

---

## 🔧 Добавление нового модератора

1. Войти как **developer**
2. Перейти в базу данных `mirageml-backend/data/users.json`
3. Добавить пользователя с ролью `moderator`:
   ```json
   {
     "id": "unique-id",
     "name": "Имя Модератора",
     "email": "newmod@mirageml.com",
     "password": "$2b$10$...",  // bcrypt хеш
     "role": "moderator",
     "roleDisplay": "Модератор",
     "theme": "dark",
     "country": "ru",
     "createdAt": "2026-02-19T..."
   }
   ```

4. Сгенерировать хеш пароля можно через Node.js:
   ```javascript
   const bcrypt = require('bcryptjs');
   const hash = bcrypt.hashSync('пароль', 10);
   ```
